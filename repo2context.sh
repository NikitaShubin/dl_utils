#!/bin/bash

# –°–æ–∑–¥–∞—ë—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª, –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–µ –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è LLM.
#
# –í –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Ö–æ–¥–∏—Ç:
#   1) –¥—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã;
#   2) —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞–∂–¥–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞.
#
# –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
#   - –ø—É—Ç—å –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é.
# –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã:
#   - —Ñ–∞–π–ª "<–ø—É—Ç—å –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é>/repo.txt", —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ.
#
# –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
#   –ò–≥–æ—Ä–∏—Ä—É—é—Ç—Å—è:
#     - –ø–∞–ø–∫–∏ –∏ —Ñ–∞–π–ª—ã .git;
#     - —Å–∞–º —Å–∫—Ä–∏–ø—Ç repo2context.sh;
#     - –≤—Å–µ —Ñ–∞–π–ª—ã repo.txt, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏–π;
#     - –±–∏–Ω–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã.

# –ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å)
OUTPUT="repo.txt"
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_NAME=$(basename "$0")

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ stdout - —Ç–µ—Ä–º–∏–Ω–∞–ª)
if [ -t 1 ]; then
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    CYAN='\033[0;36m'
    NC='\033[0m' # No Color
else
    GREEN=''; YELLOW=''; CYAN=''; NC=''
fi

TARGET_DIR="${1:-.}"
cd "$TARGET_DIR" || exit 1

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ç–∏–ª–∏—Ç—ã tree
if ! command -v tree &> /dev/null; then
    echo "–û—à–∏–±–∫–∞: —É—Ç–∏–ª–∏—Ç–∞ 'tree' –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤–Ω–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞
TEMP_FILE=$(mktemp -p /tmp)

# 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã (–∏—Å–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏ –∏—Ç–æ–≥–æ–≤—ã–π —Ñ–∞–π–ª)
{
    echo "=== –°–¢–†–£–ö–¢–£–†–ê –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø ==="
    tree -a -I ".git|__pycache__|node_modules|*.pyc|$OUTPUT|$SCRIPT_NAME" --dirsfirst . 2>/dev/null
    echo -e "\n\n=== –°–û–î–ï–†–ñ–ò–ú–û–ï –¢–ï–ö–°–¢–û–í–´–• –§–ê–ô–õ–û–í ==="
} > "$TEMP_FILE"

# 2. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
find . -type f ! -path "./.git/*" ! -name "$OUTPUT" ! -name "$SCRIPT_NAME" -print0 | while IFS= read -r -d '' file; do
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–∞–π–ª —Ç–µ–∫—Å—Ç–æ–≤—ã–º –ø–æ –∫–æ–¥–∏—Ä–æ–≤–∫–µ
    if file -b --mime-encoding "$file" | grep -q -E 'utf-8|us-ascii|iso-8859'; then
        {
            echo -e "\n--- –§–∞–π–ª: $file ---"
            cat "$file" 2>/dev/null
            echo ""
        } >> "$TEMP_FILE"
    fi
done

# 3. –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è
echo -e "\n\n=== –ö–û–ù–ï–¶ –ü–ï–†–ï–ß–ò–°–õ–ï–ù–ò–Ø –§–ê–ô–õ–û–í ===" >> "$TEMP_FILE"

# –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ
mv "$TEMP_FILE" "$OUTPUT"

# –¶–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª
echo -e "${GREEN}‚úì –ü—Ä–æ–º–ø—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤:${NC} $(pwd)/$OUTPUT"
echo -e "${CYAN}üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:${NC} $(wc -l < "$OUTPUT") —Å—Ç—Ä–æ–∫"
echo -e "${YELLOW}üö´ –ò—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –≤—ã–≤–æ–¥–∞:${NC} $SCRIPT_NAME, $OUTPUT"