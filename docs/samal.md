# Модуль [`samal.py`](../samal.py)

Предоставляет инструменты для автоматической разметки изображений с использованием
Segment Anything Model (SAM). Основное назначение - предварительная разметка данных
в CVAT и обработка результатов сегментации.

---

## Основные компоненты

### Классы

| Класс | Описание                                           |
|-------|----------------------------------------------------|
| `SAM` | основной класс для работы с Segment Anything Model |

---

## Описание классов

### Класс `SAM`

Инкапсулирует Segment Anything Model с наиболее востребованными функциями обработки изображений.

#### Конструктор

```python
SAM(
    model_path='../sam_vit_h_4b8939.pth',
    device='auto',
    use_tta=True,
    postprocess_filters=[]
)
```

#### Параметры

- `model_path` - путь к файлу весов модели или список путей;
- `device` - вычислительное устройство (`auto` для автоматического выбора);
- `use_tta` - использовать Test Time Augmentation;
- `postprocess_filters` - список фильтров для постобработки масок.

#### Основные методы

| Метод                | Назначение                                           |
|----------------------|------------------------------------------------------|
| `img2masks()`        | генерация масок для изображения                      |
| `masks2df()`         | преобразование масок в датафрейм CVAT                |
| `img2df()`           | полный цикл: изображение → маски → датафрейм CVAT    |
| `img_file2subtask()` | обработка файла изображения и возврат подзадачи CVAT |

#### Особенности

- автоматическая загрузка моделей при отсутствии локальных копий;
- поддержка ансамбля моделей (несколько моделей одновременно);
- Test Time Augmentation включает 8 вариантов аугментации (отражения, повороты);
- совместимость с фильтрами из модуля `seg.py`.

---

## Примеры использования

### Базовая сегментация

```python
sam = SAM(model_path='sam_vit_h_4b8939.pth')
masks = sam.img2masks(image)
df = sam.masks2df(masks)
```

### С постобработкой

```python
filters = [Morphology('close', kernel=3), DropDuplicates(max_iou=0.8)]
sam = SAM(model_path='sam_vit_b.pth', postprocess_filters=filters)
df = sam.img2df(image)
```

### Обработка файла

```python
subtask = sam.img_file2subtask('image.jpg')
```

---

## Примечания

- Модели автоматически загружаются с официального репозитория Facebook Research;
- TTA значительно улучшает качество сегментации, но увеличивает время обработки в 8 раз;
- Поддерживаются модели: ViT-H, ViT-L, ViT-B, ViT-Tiny;
- Формат вывода совместим с CVAT для импорта разметки.
