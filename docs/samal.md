# Модуль [`samal.py`](https://github.com/NikitaShubin/dl_utils/blob/main/samal.py "Перейти к модулю")

Модуль предоставляет инструменты для автоматической разметки изображений с использованием Segment Anything Model (SAM).
Основное назначение - предварительная разметка данных в CVAT и обработка результатов сегментации.

---
## Основные возможности

### Ключевые функции:
- автоматическая сегментация изображений с помощью SAM;
- фильтрация и постобработка масок (морфология, декомпозиция, удаление дубликатов);
- преобразование масок в формат CVAT;
- подгонка контуров сегментов для устранения пересечений.

---

## Основные компоненты

### Классы

| Класс            | Описание                                           |
|------------------|----------------------------------------------------|
| `MasksFilter`    | базовый класс для фильтрации масок                 |
| `PrintMasksNum`  | вывод количества масок (для отладки)               |
| `Morphology`     | морфологические операции над масками               |
| `DropDuplicates` | удаление дубликатов масок по IoU                   |
| `Decompose`      | декомпозиция масок на составляющие                 |
| `Cutter`         | вырезание вложенных сегментов                      |
| `MajorSegment`   | выделение главного сегмента                        |
| `FitMasks`       | подгонка контуров масок для устранения пересечений |
| `SAM`            | основной класс для работы с Segment Anything Model |

### Функции

| Функция                          | Назначение                                                                                                              |
|----------------------------------|-------------------------------------------------------------------------------------------------------------------------|
| `masks2tensor()`                 | конвертация списка масок в 3D-тензор                                                                                    |
| `tensor2masks()`                 | обратное преобразование тензора в список масок                                                                          |
| `DropByArea(min_area, max_area`) | создаёт функтор, выбрасывающий из списка масок те из них, чьи размеры выходят за рамки диапазона `[min_area, max_area]` |
| `fit_segments_in_df()`           | подгонка контуров сегментов в датафрейме CVAT                                                                           |

---

## Описание классов

### `MajorSegment`
Выбирает одну маску, максимально близкую шаблонной. 
Все входящие в её меньшие сегменты удаляются, а из всех больших сегментов, в которые этот сегмент сам входит, он вычитается. 
Т.е. этот объект как бы становится главным в заданной области.

Используется, если есть представление о том, что какой-то крупный объект занимает значительную область
кадра и входящие в него подсегменты можно удалить, а более крупные области от него отделить.

#### Параметры:
- `drop_small_parts`: удалять мелкие фрагменты масок.

### `SAM`

#### Основные методы
| Метод         | Назначение                                                                   |
|---------------|------------------------------------------------------------------------------|
| `img2masks()` | генерация масок для изображения                                              |
| `masks2df()`  | преобразование масок в датафрейм CVAT                                        |
| `img2df()`    | полный цикл от изображения до разметки: изображение → маски → датафрейм CVAT |

#### Параметры инициализации:
- `model_path`: путь к весам модели SAM;
- `device`: вычислительное устройство (`auto` для автоматического выбора);
- `postprocess_filters`: список фильтров для постобработки масок.