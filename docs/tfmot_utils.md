# Модуль `tfmot_utils.py`

Модуль `tfmot_utils.py` предоставляет утилиты для работы с оптимизацией нейронных сетей в TensorFlow, включая:
- Квантование моделей (quantization)
- Прунинг (pruning) моделей
- Тестирование совместимости популярных архитектур с оптимизацией
- Управление окружением для корректной работы с tf_keras

Основные функции модуля используют библиотеки:
- `tensorflow_model_optimization` (tfmot) для квантования и прунинга
- `keras` (через tf_keras) для работы с моделями
- Вспомогательные инструменты для обработки исключений и конфигурации

## Основные компоненты

### Классы конфигурации квантования
1. **`NoOpQuantizeConfig`**:
   - Пустая конфигурация, не выполняющая квантование
   - Используется для слоёв, которые не должны квантоваться

2. **`DefaultBNQuantizeConfig`**:
   - Специализированная конфигурация для слоёв BatchNormalization
   - Использует 8-битный квантователь MovingAverageQuantizer

### Класс `Quantize`
- **Основной функционал**:
  - Предоставляет методы для аннотации и квантования моделей
  - Поддерживает загрузку моделей с квантованными слоями через `load_model`
  - Автоматически обрабатывает компиляцию модели после квантования

- **Поддерживаемые слои**:
  - BatchNormalization - с отдельной конфигурацией квантования
  - Rescaling, Normalization, Multiply и другие - без квантования
  - Остальные слои - стандартное квантование

- **Особенности**:
  - Использует механизм `custom_object_scope` для корректной загрузки моделей
  - Сохраняет оригинальные параметры компиляции модели

### Функции для прунинга
1. **`prune_low_magnitude`**:
   - Подготавливает модель для прунинга, пропуская неподдерживаемые слои
   - Рекурсивно обрабатывает вложенные модели

2. **`unprune`**:
   - Удаляет обвес прунинга из модели (аналог `strip_pruning`)

3. **`get_pruning_callbacks`**:
   - Генерирует стандартные колбеки для прунинга
   - Поддерживает интеграцию с TensorBoard

### Тестирование совместимости
- **`test_aplications`**:
  - Тестирует поддержку квантования для стандартных моделей Keras Applications
  - Автоматически определяет и обрабатывает типовые ошибки
  - Визуализирует результаты через цветовую маркировку (зелёный/красный)

## Обработка исключений и особых случаев
- **Типовые ошибки**:
  - Проблемы с рангами тензоров
  - Вложенные модели
  - Неподдерживаемые операции (например, простая сумма тензоров)

- **Особые слои**:
  - Слои предобработки (Resizing, Rescaling) исключаются из прунинга
  - Кастомные слои (например, CustomScaleLayer) могут быть добавлены в исключения

## Конфигурация окружения
- Принудительное использование `tf_keras` вместо стандартного Keras
- Настройка через переменные окружения (`KERAS_MODULE`)
