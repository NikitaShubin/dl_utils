# Модуль [`tfmot_utils.py`](https://github.com/NikitaShubin/dl_utils/blob/main/tfmot_utils.py "Перейти к модулю")

Предоставляет утилиты для работы с оптимизацией нейронных сетей в TensorFlow, включая:
- квантование моделей (quantization);
- прунинг (pruning) моделей;
- тестирование совместимости популярных архитектур с оптимизацией;
- управление окружением для корректной работы с tf_keras.

Основные функции модуля используют библиотеки:
- `tensorflow_model_optimization` (tfmot) для квантования и прунинга;
- `keras` (через tf_keras) для работы с моделями;
- вспомогательные инструменты для обработки исключений и конфигурации.

---

## Основные компоненты

| Класс                     | Назначение                                                                             |
|---------------------------|----------------------------------------------------------------------------------------|
| `NoOpQuantizeConfig`      | пустая конфигурация, не выполняющая квантизации                                        |
| `DefaultBNQuantizeConfig` | конфигурация, выполняющая квантизацию слоёв пакетной нормализации (BatchNormalization) |
| `Quantize`                | применения квантизации к моделям TensorFlow/Kera                                       |

### Особенности классов
`NoOpQuantizeConfig`:
- используется для слоёв, которые не должны квантоваться.

`DefaultBNQuantizeConfig`:
- использует 8-битный квантователь MovingAverageQuantizer.

`Quantize`:
- **основная функциональность**:
  - предоставляет методы для аннотации и квантования моделей;
  - поддерживает загрузку моделей с квантованными слоями через `load_model`;
  - автоматически обрабатывает компиляцию модели после квантования.

- **поддерживаемые слои**:
  - BatchNormalization - с отдельной конфигурацией квантования;
  - Rescaling, Normalization, Multiply и другие - без квантования;
  - остальные слои - стандартное квантование.

- **особенности**:
  - использует механизм `custom_object_scope` для корректной загрузки моделей;
  - сохраняет оригинальные параметры компиляции модели.

### Функции

| Функция                      | Назначение                                                                                                                             |
|------------------------------|----------------------------------------------------------------------------------------------------------------------------------------|
| `test_aplications(...)`      | тестирует на поддержку конвертации в модель обучения с учётом квантизации всех доступных конструкторов моделей из объекта applications |
| `prune_low_magnitude(...)`   | готовит к прунингу только поддерживаемые слои                                                                                          |
| `get_pruning_callbacks(...)` | создаёт список колбеков для прунинга                                                                                                   |

### Особенности функций

`test_aplications(applications include_top)`:
  - тестирует поддержку квантования для стандартных моделей Keras Applications;
  - автоматически определяет и обрабатывает типовые ошибки;
  - визуализирует результаты через цветовую маркировку (зелёный/красный).

`prune_low_magnitude(layer, **kwargs)`:
   - рекурсивно обрабатывает вложенные модели.

`get_pruning_callbacks(tensorboard_dir)`:
   - поддерживает интеграцию с TensorBoard.

---

## Обработка исключений и особых случаев
- **Типовые ошибки**:
  - проблемы с рангами тензоров;
  - вложенные модели;
  - неподдерживаемые операции (например, простая сумма тензоров).

- **Особые слои**:
  - слои предобработки (Resizing, Rescaling) исключаются из прунинга;
  - кастомные слои (например, CustomScaleLayer) могут быть добавлены в исключения.

---

## Конфигурация окружения
- Принудительное использование `tf_keras` вместо стандартного Keras.
- Настройка через переменные окружения (`KERAS_MODULE`).