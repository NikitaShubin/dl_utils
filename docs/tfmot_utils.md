# Модуль [`tfmot_utils.py`](../tfmot_utils.py "Перейти к модулю")

Предоставляет утилиты для работы с оптимизацией нейронных сетей в TensorFlow,
включая:

- квантование моделей (quantization);
- прунинг (pruning) моделей;
- тестирование совместимости популярных архитектур с оптимизацией;
- управление окружением для корректной работы с tf_keras.

Основные функции модуля используют библиотеки:

- `tensorflow_model_optimization` (tfmot) для квантования и прунинга;
- `keras` (через tf_keras) для работы с моделями;
- вспомогательные инструменты для обработки исключений и конфигурации.

---

## Основные компоненты

| Класс                     | Назначение                                        |
|---------------------------|---------------------------------------------------|
| `NoOpQuantizeConfig`      | пустая конфигурация без квантизации               |
| `DefaultBNQuantizeConfig` | конфигурация квантизации для BatchNormalization   |
| `Quantize`                | применение квантизации к моделям TensorFlow/Keras |

### Особенности классов

`NoOpQuantizeConfig`:

- используется для слоёв, которые не должны квантоваться.

`DefaultBNQuantizeConfig`:

- использует 8-битный квантователь MovingAverageQuantizer.

`Quantize`:

- **основная функциональность**:
  - предоставляет методы для аннотации и квантования моделей;
  - поддерживает загрузку моделей с квантованными слоями через `load_model`;
  - автоматически обрабатывает компиляцию модели после квантования.

- **поддерживаемые слои**:
  - BatchNormalization - с отдельной конфигурацией квантования;
  - Rescaling, Normalization, Multiply и другие - без квантования;
  - остальные слои - стандартное квантование.

- **особенности**:
  - использует механизм `custom_object_scope` для корректной загрузки моделей;
  - сохраняет оригинальные параметры компиляции модели.

### Функции

| Функция                      | Назначение                                      |
|------------------------------|-------------------------------------------------|
| `test_aplications(...)`      | тестирует поддержку квантизации у моделей Keras |
| `prune_low_magnitude(...)`   | готовит поддерживаемые слои к прунингу          |
| `get_pruning_callbacks(...)` | создаёт колбеки для прунинга                    |

### Особенности функций

`test_aplications(applications include_top)`:

- тестирует поддержку квантования для стандартных моделей Keras Applications;
- автоматически определяет и обрабатывает типовые ошибки;
- визуализирует результаты через цветовую маркировку (зелёный/красный).

`prune_low_magnitude(layer, **kwargs)`:

- рекурсивно обрабатывает вложенные модели.

`get_pruning_callbacks(tensorboard_dir)`:

- поддерживает интеграцию с TensorBoard.

---

## Обработка исключений и особых случаев

- **Типовые ошибки**:
  - проблемы с рангами тензоров;
  - вложенные модели;
  - неподдерживаемые операции (например, простая сумма тензоров).

- **Особые слои**:
  - слои предобработки (Resizing, Rescaling) исключаются из прунинга;
  - кастомные слои (например, CustomScaleLayer) могут быть добавлены в исключения.

---

## Конфигурация окружения

- Принудительное использование `tf_keras` вместо стандартного Keras.
- Настройка через переменные окружения (`KERAS_MODULE`).
