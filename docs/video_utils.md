# Модуль [`video_utils.py`](https://github.com/NikitaShubin/dl_utils/blob/main/video_utils.py "Перейти к модулю")

Предоставляет комплексные утилиты для работы с видео и изображениями, включая:
- обработку и конвертацию видеофайлов;
- работу с оптическим потоком;
- создание конвейеров обработки изображений;
- генерацию и обработку видеопоследовательностей;
- визуализацию семантической сегментации.

Интегрирован с OpenCV и поддерживает многозадачную обработку.

---

## Основные возможности

### Ключевые функции:
- **конвертация видео**: пересжатие в MP4, изменение форматов;
- **обработка видеопотоков**: применение фильтров, наложение текста, семантическая сегментация;
- **оптический поток**: расчёт и применение деформаций;
- **работа с кадрами**: чтение/запись, буферизация, случайная обрезка;
- **генерация видео**: сборка из изображений, демо-коллажи.

---

## Основные компоненты

### Классы

| Класс                  | Описание                                                      |
|------------------------|---------------------------------------------------------------|
| `Pipeline`             | конвейер фильтров для обработки изображений/видео             |
| `ViRead`/`ViSave`      | чтение и запись видеофайлов с поддержкой цветовых пространств |
| `Resize`               | изменение размера изображения с сохранением пропорций         |
| `AddCaption`           | наложение контрастного текста на изображение                  |
| `CompareTwoFilters`    | визуальное сравнение результатов двух фильтров                |
| `VideoGenerator`       | генератор для чтения кадров из видео/изображений              |
| `OptFlow`              | расчёт и применение оптического потока (Farneback)            |
| `StoreLastFrames`      | хранение предыдущих кадров для временного анализа             |

### Функции

| Функция              | Назначение                                    |
|----------------------|-----------------------------------------------|
| `recomp2mp4`         | пересжаие видео с контролем качества (CRF 20) |
| `apply2video`        | применение фильтра ко всем кадрам видео       |
| `convert_videos`     | пакетная конвертация видео в целевой директории |
| `color_canny`        | трёхканальный детектор границ Кэнни           |
| `apply_flow2img`     | деформация изображения по оптическому потоку  |
| `get_file_list`      | рекурсивный поиск видео/изображений по расширениям |

---

## Основные методы классов

### `Pipeline`
| Метод        | Назначение                        |
|--------------|-----------------------------------|
| `concat`     | объединение фильтров в цепочку    |
| `convert`    | применение конвейера к видеофайлу |
| `reset`      | сброс состояний всех фильтров     |

### `ViRead`
| Метод        | Назначение              |
|--------------|-------------------------|
| `__call__`   | чтение следующего кадра |
| `reset`      | перезапуск видеопотока  |
| `close`      | освобождение ресурсов   |

### `OptFlow`
| Метод                    | Назначение                              |
|--------------------------|-----------------------------------------|
| `__call__`               | расчёт оптического потока между кадрами |
| `create_meshgrid`        | генерация координатной сетки            |
| `apply_flow2meshgrid`    | деформация сетки по оптическому потоку  |
| `seq_flows`          | расчёт последовательных потоков между кадрами   |
| `apply_flows2img`    | восстановление видео по первому кадру и потокам |

### `VideoGenerator`
| Метод         | Назначение                              |
|---------------|-----------------------------------------|
| `__iter__`    | итерация по кадрам                      |
| `__getitem__` | доступ к кадру по индексу               |
| `append`      | добавление источника в список обработки |