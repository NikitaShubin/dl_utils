# Модуль [`seg.py`](https://github.com/NikitaShubin/dl_utils/blob/main/seg.py "Перейти к модулю")

Предназначен для работы с датасетами семантической сегментации.
Он предоставляет функции для:
- конвертации задач из формата CVAT в датасет сегментации;
- создания цветных превью для визуализации масок;
- фильтрации однородных (неразмеченных) кадров;
- генерации видео-превью из набора изображений.

Основные функции модуля используют библиотеки OpenCV (`cv2`), `NumPy` и дополнительные утилиты из локального модуля `utils`.

---

## Основные функции

| Функция                           | Назначение                                                                      |
|-----------------------------------|---------------------------------------------------------------------------------|
| `save_task2segmentation_dataset`  | сохраняет отдельную задачу (task) в виде набора файлов для датасета сегментации |
| `save_tasks2segmentation_dataset` | обрабатывает список задач и сохраняет их в структурированный датасет            |
| `drop_homogeneous_labeled_frames` | фильтрует кадры, где все пиксели принадлежат одному классу (неразмеченные)      |

### `save_task2segmentation_dataset`
  - Поддерживает фильтрацию кадров с исключёнными классами (метка `-2`);
  - Генерирует три типа файлов: исходные изображения (`inp`), маски (`out`) и превью (`prv`);
  - Для превью использует цветовую кодировку: зелёный для обычных объектов, красный для исключённых, синий для неиспользуемых;
  - Сохраняет метаинформацию (название проекта, задачи и номер кадра) на превью.

### `save_tasks2segmentation_dataset`
  - Автоматически создаёт папки `inp`, `out` и (опционально) `prv`;
  - Сортирует задачи по количеству кадров для оптимальной обработки;
  - Поддерживает параллельную обработку через `mpmap`.

### `drop_homogeneous_labeled_frames`
  - Работает со всеми подвыборками датасета;
  - Удаляет соответствующие файлы изображений, масок и превью;
  - Подсчитывает и выводит количество удалённых семплов.

### Функции для работы с превью

| Функция                            | Назначение                                                                                                                                          |
|------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| `draw_seg_prev`                    | - создаёт цветное превью, накладывая маску сегментации на исходное изображение; <br/> - использует HSV-цветовое пространство для кодировки классов. |
| `make_seg_subset_colored_preview`  | - генерирует превью для подвыборки датасета (train/val/test); <br/> - поддерживает создание видео из набора превью.                                 |
| `make_seg_dataset_colored_preview` | организует обработку всех подвыборок датасета (train, val, test)                                                                                    |

## Вспомогательные компоненты
- **Цветовая кодировка**:
  - классы кодируются оттенками в HSV (от 0 до 180°);
  - насыщенность всегда максимальна (255).
  
- **Обработка исключений**:
  - кадры с меткой `-2` полностью исключаются из датасета;
  - кадры с меткой `-1` отмечаются на превью, но сохраняются в датасете.

- **Параллельная обработка**:
  - используется функция `mpmap` для ускорения обработки больших наборов данных.
