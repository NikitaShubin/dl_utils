# Модуль [`seg.py`](../seg.py "Перейти к модулю")

Предназначен для работы с сегментами и сегментацией изображений.
Содержит инструменты для фильтрации, морфологической обработки,
декомпозиции масок и работы с датасетами семантической сегментации.

---

## Основные возможности

### Ключевые функции

- преобразование между списками масок и тензорами;
- морфологические операции над масками;
- фильтрация масок по площади и удаление дубликатов;
- декомпозиция и комбинаторика масок;
- подгонка контуров сегментов;
- работа с датасетами сегментации;
- создание цветных превью и видео.

---

## Основные компоненты

### Классы

| Класс            | Описание                                                |
|------------------|---------------------------------------------------------|
| `MasksFilter`    | базовый класс для фильтров обработки списков масок      |
| `Morphology`     | морфологические операции над масками                    |
| `DropDuplicates` | удаление дубликатов масок по IoU                        |
| `Decompose`      | декомпозиция масок на составляющие                      |
| `Cutter`         | вырезание вложенных сегментов                           |
| `MajorSegment`   | выделение главного сегмента в области                   |
| `FitMasks`       | подгонка контуров масок для устранения пересечений      |

### Функции

| Функция                            | Назначение                            |
|------------------------------------|---------------------------------------|
| `masks2tensor()`                   | объединение масок в 3D-тензор         |
| `tensor2masks()`                   | преобразование тензора в список масок |
| `DropByArea()`                     | создание фильтра по площади масок     |
| `isolate_segments`                 | разделение несвязных сегментов        |
| `drop_shards`                      | оставление самого большого сегмента   |
| `fit_segments_in_df()`             | подгонка контуров в датафрейме CVAT   |
| `save_tasks2segmentation_dataset`  | создание датасета из задач CVAT       |
| `make_seg_dataset_colored_preview` | создание цветных превью для датасета  |

---

## Описание классов

### Класс `MasksFilter`

Базовый класс-декоратор для создания фильтров, обрабатывающих списки масок.

#### Особенности

- может использоваться как декоратор для функций обработки одной маски;
- автоматически обрабатывает случаи, когда фильтр возвращает несколько масок;
- пропускает `None` результаты.

### Класс `Morphology`

Выполняет морфологические операции над масками.

#### Поддерживаемые операции

- `dilate` - дилатация (расширение)
- `erode` - эрозия (сужение)
- `close` - закрытие (дилатация + эрозия)
- `open` - открытие (эрозия + дилатация)

#### Параметры морфологических операций

- `kernel` - структурный элемент (целое число, float или numpy array);
- при float ядро рассчитывается относительно размера сегмента.

### Класс `DropDuplicates`

Удаляет дубликаты масок на основе порога IoU (Intersection over Union).

#### Алгоритм удаления дубликатов

1. Сортировка масок по площади
2. Построение матрицы IoU между всеми парами масок
3. Удаление масок с IoU > порога

#### Параметры удаления дубликатов

- `max_iou` - порог IoU для определения дубликатов (по умолчанию 0.85);
- `total_parallel_num` - количество параллельных процессов.

### Класс `Decompose`

Декомпозиция масок путём перебора всевозможных комбинаций вычитаний и объединений.

#### Создаваемые комбинации

- вычитание одной маски из другой;
- объединение масок;
- пересечение масок.

#### Параметры декомпозиции

- `min_overlap` - минимальное перекрытие для вычитания;
- `min_iou` - минимальный IoU для комбинирования;
- `steps` - количество итераций декомпозиции.

### Класс `MajorSegment`

Выделяет главный сегмент в заданной области интереса.

#### Применение выделения главного сегмента

- используется когда крупный объект занимает значительную область;
- удаляет мелкие сегменты внутри главного;
- вычитает главный сегмент из более крупных областей.

### Класс `FitMasks`

Подгоняет контуры сегментов так, чтобы каждый пиксель изображения
принадлежал только одной маске.

#### Алгоритм подгонки масок

1. Построение карты расстояний до ближайших сегментов
2. Распределение спорных пикселей в пользу ближайшего сегмента
3. Опциональное удаление мелких фрагментов

---

## Примеры использования

### Фильтрация масок по площади

```python
filtered_masks = DropByArea(min_area=100, max_area=0.5)(masks)
```

### Морфологическое закрытие

```python
closed_masks = Morphology('close', kernel=5)(masks)
```

### Удаление дубликатов

```python
unique_masks = DropDuplicates(max_iou=0.9)(masks)
```

### Создание датасета сегментации

```python
save_tasks2segmentation_dataset(
    tasks, 
    '/path/to/dataset', 
    labels_convertor, 
    make_preview=True
)
```

---

## Примечания

- Поддерживается параллельная обработка через `mpmap`;
- Все операции сохраняют тип и устройство тензоров;
- Фильтры можно комбинировать в цепочки обработки;
- Совместимо с форматом CVAT для импорта/экспорта разметки.
