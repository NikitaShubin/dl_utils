# Модуль [`keras_utils.py`](https://github.com/NikitaShubin/dl_utils/blob/main/keras_utils.py "Перейти к модулю")

Предоставляет инструменты для работы с библиотекой Keras/TensorFlow в задачах глубокого обучения. Основная функциональность включает создание моделей, работу с данными, кастомизацию метрик и колбеков, а также интеграцию с TensorBoard.

---
## Основные возможности

### Ключевые функции:
- создание и настройка моделей (UNet, Deeplabv3+, Fractal-U-Net);
- работа с загрузчиками данных для задач сегментации;
- кастомные метрики (F-мера, пороговая оптимизация);
- колбеки для управления обучением (прогрев, ранняя остановка, обработка сигналов);
- интеграция с TensorBoard и визуализация истории обучения.

---

## Основные компоненты

### Классы

| Класс                | Описание                                                              |
|----------------------|-----------------------------------------------------------------------|
| `SegDataLoader`      | загрузчик данных для загрузки изображений и масок сегментации         |
| `BackboneShapes`     | расчёт размеров входных/выходных тензоров для базовой сети (backbone) |
| `MaxFscore`          | метрика: максимальная F-мера и оптимальный порог                      |
| `Warmup`             | колбек для постепенного увеличения скорости обучения (прогрев)        |
| `AutoFinetune`       | колбек для двухэтапного обучения (заморозка → разморозка слоёв)       |
| `DoOnKill`           | обработка сигналов завершения программы (например, `kill`)            |
| `TensorBoardContext` | контекст для запуска TensorBoard                                      |

### Функции

| Функция                                        | Назначение                                                   |
|------------------------------------------------|--------------------------------------------------------------|
| `backbone2encoder`                             | преобразование базовой модели в энкодер для U-Net-архитектур |
| `get_keras_application_model_constructor_list` | получение списка доступных моделей Keras Applications        |
| `UNet`                                         | сборка модели U-Net на основе backbone                       |
| `Deeplabv3Plus`                                | сборка модели Deeplabv3+                                     |
| `make_fractal_unet`                            | создание фрактальной U-Net архитектуры                       |
| `global_pool_2D_with_bottleneck`               | глобальный пулинг с "бутылочным горлышком"                   |

---

## Описание классов

### Класс `SegDataLoader`
Класс для загрузки и аугментации данных сегментации.

| Метод          | Назначение                                                  |
|----------------|-------------------------------------------------------------|
| `__init__`     | инициализация путей, параметров аугментации и размера батча |
| `on_epoch_end` | перемешивание данных в конце эпохи                          |
| `__getitem__`  | формирование батча данных                                   |
| `show`         | визуализация случайного батча через matplotlib              |

#### Параметры инициализации:
- `path`: путь к папкам с данными (`inp` и `out`);
- `transforms`: аугментации (например, Albumentations);
- `batch_size`, `shuffle`, `drop_incomplete_batch`: настройки батчей.

---

### Класс `MaxFscore`
Метрика для вычисления F-меры и оптимального порога бинаризации.

| Метод          | Назначение                                 |
|----------------|--------------------------------------------|
| `__init__`     | Инициализация параметров (beta, режим)     |
| `result`       | Расчёт F-меры и порога                     |

#### Параметры инициализации:
- `mode`: режим вывода (`'F'`, `'TH'`, `'F+TH'`);
- `beta`: коэффициент баланса между точностью и полнотой.

---

### Колбеки

| Класс          | Назначение                                                   |
|----------------|--------------------------------------------------------------|
| `Warmup`       | постепенно увеличивает скорость обучения в начале тренировки |
| `AutoFinetune` | двухэтапное обучение: заморозка → разморозка слоёв           |
| `DoOnKill`     | обработка внешних сигналов (например, `kill` или `Ctrl+C`)   |

---

## Вспомогательные функции

### `backbone2encoder(backbone, return_outputs=False)`
Преобразует базовую модель в энкодер для U-Net.
- `backbone`: модель (например, ResNet, MobileNet).
- `return_outputs`: возвращать выходы слоёв или модель.

### Архитектуры моделей
Реализации популярных сетей для сегментации

| Архитектура | Функция               | Описание                            |
|-------------|-----------------------|-------------------------------------|
| UNet        | `UNet()`              | классическая U-образная архитектура |
| Deeplabv3+  | `Deeplabv3Plus()`     | модель с ASPP-модулями              |
| FractalUNet | `make_fractal_unet()` | кастомная фрактальная версия UNet   |

---

## Статические методы и утилиты

### Работа с тензорами
| Метод                          | Назначение                                      |
|--------------------------------|-------------------------------------------------|
| `global_pool_conv2D`           | Глобальный пулинг с последующей свёрткой        |
| `Resizing2DLike`               | Масштабирование тензора до заданного размера    |

### Интеграция с TensorBoard:
- `TensorBoardContext`: запуск TensorBoard и вывод URL.
- `KerasHistory`: сохранение и визуализация истории обучения.