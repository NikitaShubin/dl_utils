# Модуль `keras_utils.py`

Модуль содержит набор инструментов для работы с фреймворком Keras/TensorFlow, включая:
- Динамическую загрузку различных версий Keras
- Утилиты для построения моделей нейронных сетей
- Пользовательские метрики и callback-функции
- Механизмы дистилляции знаний
- Инструменты управления процессом обучения

## Основные компоненты

### 1. Динамический импорт Keras
Поддерживает загрузку разных реализаций Keras через переменную окружения `KERAS_MODULE`:
- Стандартный Keras (`keras`)
- Версия из TensorFlow (`tf.keras`)
- Версия для квантованных моделей (`tfmot`)
- Алиасная версия (`tf_keras`)

### 2. Утилиты для работы с моделями

#### `BackboneShapes`
Вычисляет оптимальные размеры тензоров для базовых сетей с учётом:
- Исходного размера входных данных
- Желаемого масштабирования
- Количества слоёв пулинга
- Числа выходных фильтров

#### `backbone2encoder()`
Преобразует базовую модель в энкодер с выходами разных масштабов:
- Автоматически находит слои с уменьшением размерности
- Работает с моделями как с фиксированными, так и с динамическими размерами

#### Архитектуры моделей
Реализации популярных сетей для сегментации:
- **UNet**: классическая U-образная архитектура
- **Deeplabv3+**: модель с ASPP-модулями
- **FractalUNet**: кастомная фрактальная версия UNet

### 3. Пользовательские метрики

#### `MaxFscore`
Вычисляет:
- Максимальное значение F-меры
- Оптимальный порог бинаризации
- Поддерживает параметр beta для баланса точности и полноты

### 4. Callback-функции

#### Управление обучением
- `TrainingMode`: контроль режима training/inference
- `Warmup`: постепенный рост learning rate
- `AutoFinetune`: двухэтапное обучение (заморозка + тонкая настройка)

#### Безопасность
- `DoOnKill`: обработка сигналов прерывания
- `CarefulStopping`: корректное завершение обучения

#### Визуализация
- `TensorBoardContext`: удобная работа с TensorBoard

### 5. Дистилляция знаний

#### `Distiller`
Реализация механизма дистилляции:
- Поддержка любых архитектур teacher/student
- Настройка температуры дистилляции
- Баланс между losses студента и учителя

### 6. Вспомогательные инструменты

#### `SegDataLoader`
Загрузчик данных для задач сегментации:
- Поддержка аугментаций
- Различные форматы масок
- Многопоточная загрузка

#### `recompile_model`
Безопасная перекомпиляция моделей