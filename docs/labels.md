# Модуль [`labels.py`](https://github.com/NikitaShubin/dl_utils/blob/main/labels.py "Перейти к модулю")

Предоставляет функциональность для работы с метками и суперметками, хранящимися в Excel-файлах. Основное назначение - конвертация между различными системами обозначений меток и организация иерархических связей между ними.

---

## Основные компоненты

### Классы

| Класс | Описание |
|-------|----------|
| `LabelsConvertor` | основной класс для конвертации меток между различными форматами |
| `CoreLabelsConvertor` | базовый класс, обеспечивающий основные методы работы со словарём меток |

---

## Описание классов

### Класс `LabelsConvertor`
Основной класс для конвертации меток между различными форматами представления.

#### Концепция:
Используется цепочка преобразований:
- **label** → оригинальное название метки
- **meaning** → расшифровка метки (может быть на русском языке)  
- **superlabel** → название суперметки (объединяет несколько меток)
- **superind** → номер суперметки

#### Конструктор
```python
LabelsConvertor(
    labels2meanings: str | dict,
    meanings2superlabels: str | dict | None = None,
    main_dict: str = 'auto'
)
```

#### Параметры:
- `labels2meanings` - путь к Excel-файлу или словарь для перехода label → meaning;
- `meanings2superlabels` - путь к Excel-файлу или словарь для перехода meaning → superlabel;
- `main_dict` - тип основного словаря конвертации:
  - `'auto'` - автоматический выбор максимально возможной цепочки;
  - `'label2superind'` - переход от метки к номеру суперметки (YOLO-формат);
  - `'label2superlabel'` - переход от метки к метке суперметки.

#### Основные методы

| Метод | Назначение |
|-------|------------|
| `__call__()` | конвертация отдельной метки |
| `apply2df()` | применение конвертации ко всем меткам в DataFrame |
| `get_unknown_labels()` | получение множества неизвестных меток |

#### Особенности:
- поддерживает загрузку данных из Excel-файлов со строгой структурой;
- автоматически строит иерархическое дерево меток;
- проверяет уникальность и непротиворечивость меток;
- поддерживает специальные суперметки:
  - `-1` - неиспользуемые объекты;
  - `-2` - запретные объекты (кадры с ними исключаются).

### Класс `CoreLabelsConvertor`
Базовый класс, обеспечивающий основные методы работы со словарём меток.

#### Особенности:
- наследует от `dict`;
- предоставляет базовые методы для конвертации меток;
- используется `LabelsConvertor` для реализации сложной логики.

---

## Примеры использования

### Простая конвертация меток:
```python
lc = LabelsConvertor({
    'person': 'people',
    'crowd': 'people', 
    'car': 'transport',
    'plane': 'transport'
})
yolo_label = lc('person')  # Возвращает номер суперметки
```

### Конвертация с промежуточной расшифровкой:
```python
lc = LabelsConvertor(
    {
        'person': 'человек',
        'crowd': 'толпа',
        'car': 'машина', 
        'plane': 'самолёт'
    },
    {
        'человек': 'people',
        'толпа': 'people',
        'машина': 'transport',
        'самолёт': 'transport'
    }
)
```

### Загрузка из Excel-файлов:
```python
lc = LabelsConvertor('labels.xlsx', 'superlabels.xlsx')
df = lc.apply2df(original_df)
```

### Проверка неизвестных меток:
```python
unknown = lc.get_unknown_labels(['person', 'unknown_label'])
if unknown:
    print(f"Неизвестные метки: {unknown}")
```

---

## Форматы Excel-файлов

### Файл меток (`labels.xlsx`):
Файл меток `labels.xlsx` представлен примером [labels_template.xlsx](./labels_template.xlsx.md "Перейти к документации")

**Структура:**
- **Столбец A**: "Класс объекта" - иерархическая структура меток с нумерацией (римские/арабские цифры)
- **Столбец C**: "Метка в CVAT" - основное название метки для разметки
- **Столбец E**: "Метка в другом источнике данных" - синонимы/альтернативные названия

**Особенности:**
- Строгая иерархическая структура с точками в нумерации
- Поддержка римских цифр для группировки
- Автоматическое построение дерева меток

### Файл суперметок (`superlabels_template.xlsx`):
Файл меток `superlabels.xlsx` представлен примером [superlabels_template.xlsx](./superlabels_template.xlsx.md "Перейти к документации")

**Столбцы:**
- **Столбец A**: "№ п/п" - номер суперметки (преобразуется: номер - 1)
- **Столбец B**: "Наименование суперметки" - имя суперметки
- **Столбец C**: "Метки" - список меток в суперметке
- **Столбец D**: "Приоритет" - приоритет суперметки

**Специальные суперметки:**
- `0` → `-1` - неиспользуемые объекты
- `-1` → `-2` - запретные объекты (исключают кадры)

---

## Примечания

- Поддерживаются как арабские, так и римские цифры в нумерации;
- Автоматически нормализуются пробелы и строковые значения;
- Проверяется целостность и непротиворечивость данных;
- Совместимо с форматами CVAT и YOLO.