# Модуль [`onnx_utils.py`](../onnx_utils.py)

Предоставляет инструменты для работы с ONNX-моделями: конвертацию из Keras,
квантзацию, инференс и управление данными. Совместим с TensorFlow, ONNXRuntime
и ONNXMLTools.

---

## Основные возможности

### Ключевые функции

- конвертация моделей Keras в ONNX (float32, float16, int8);
- статическая и динамическая квантзация;
- извлечение весов из ONNX-моделей;
- обёртка для инференса ONNX-моделей с поддержкой GPU/CPU.

---

## Основные компоненты

### Классы

| Класс        | Описание                                                          |
|--------------|-------------------------------------------------------------------|
| `DataReader` | Преобразует генератор данных в формат для калибровки ONNX-моделей |
| `ONNXModel`  | Обёртка для выполнения предсказаний ONNX-моделями                 |

### Функции

| Функция         | Назначение                                                      |
|-----------------|-----------------------------------------------------------------|
| `keras2onnx()`  | Конвертирует Keras-модель в ONNX с поддержкой квантзации        |
| `get_weights()` | Извлекает веса из ONNX-модели                                   |

---

## Описание классов

### Класс `DataReader`

Класс для подготовки данных при квантзации ONNX-моделей.

| Метод        | Назначение                                              |
|--------------|---------------------------------------------------------|
| `__init__()` | Инициализация генератора данных и входного имени модели |
| `get_next()` | Возвращает подготовленный батч данных в формате ONNX    |

| Параметр | Назначение                                     |
|----------|------------------------------------------------|
| `ds`     | генератор данных (например, `tf.data.Dataset`) |
| `model`  | путь к ONNX-модели или объект модели           |

### Класс `ONNXModel`

Обёртка для удобного выполнения инференса ONNX-моделями.

<!-- markdownlint-disable MD013 -->
| Метод        | Назначение                                                                 |
|--------------|----------------------------------------------------------------------------|
| `__init__()` | Инициализация сессии ONNXRuntime (поддержка GPU/CPU)                       |
| `__call__()` | Применяет модель к входному изображению с автоматической обработкой данных |
<!-- markdownlint-enable MD013 -->

| Параметр | Назначение               |
|----------|--------------------------|
| `model`  | путь к ONNX-модели       |
| `name`   | имя модели (опционально) |

#### Особенности

- автоматически определяет порядок каналов (channel-first/channel-last);
- преобразует входные данные в совместимый формат (float16/float32).

---

## Описание основных функций

<!-- markdownlint-disable MD013 -->
| Функция                  | Назначение                                               | Возврат                                                                       | Аргументы                                                                                                                       |
|--------------------------|----------------------------------------------------------|-------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------|
| `keras2onnx(...)`        | конвертирует Keras-модель в ONNX с поддержкой квантзации | кортеж из объектов ONNX-моделей (float32, float16, dynamic int8, static int8) | `model`: Keras-модель; `f32`, `f16`, `dyn`, `stc`: пути для сохранения; `ds`: калибровочный датасет; `tmp_file`: временный файл |
| `get_weights(path)`      | извлекает веса из ONNX-модели                            | список массивов NumPy с весами модели                                         | `path`: путь к ONNX-модели                                                                                                      |
<!-- markdownlint-enable MD013 -->

---

## Вспомогательные утилиты

### Поддержка форматов данных

- `hwc2chw()`: преобразование формата HWC в CHW;
- `chw2hwc()`: преобразование формата CHW в HWC;
- `is_channel_first()`: проверка порядка каналов.
