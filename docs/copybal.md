# Модуль [`copybal.py`](../copybal.py "Перейти к модулю")

Реализует алгоритм копирующей балансировки датасета для задач компьютерного
зрения. Основная цель - выравнивание распределения классов объектов в датасете
путем контролируемого дублирования изображений с сохранением контекста.

---

## Основные компоненты

### Вспомогательные функции

#### Идентификация объектов

<!-- markdownlint-disable MD013 -->
| Функция                   | Назначение                                                                         |
|---------------------------|------------------------------------------------------------------------------------|
| `build_unigue_track_id()` | создание уникального идентификатора объекта на основе файла, задачи, трека и метки |
| `split_unigue_track_id()` | обратная операция разбора идентификатора                                           |
<!-- markdownlint-enable MD013 -->

#### Работа с графами связностей

<!-- markdownlint-disable MD013 -->
| Функция                             | Назначение                                                               |
|-------------------------------------|--------------------------------------------------------------------------|
| `init_object_file_graph_by_task()`  | инициализация графа для одной задачи с учетом используемых классов       |
| `init_task_object_file_graphs()`    | массовая инициализация графов для всех задач                             |
| `update_object_file_graphs()`       | обновление графов новыми связями                                         |
| `drop_unused_track_ids_in_graphs()` | очистка графов от неиспользуемых объектов                                |
<!-- markdownlint-enable MD013 -->

### Основные функции балансировки

#### `make_copy_bal()`

- координирует весь процесс балансировки;
- выполняет подготовку путей и структур данных;
- парсинг графов связностей;
- оптимизацию числа копий через `torch_copy_bal`;
- создание дубликатов файлов.

#### `torch_copy_bal()`

- реализует итеративный процесс оптимизации с использованием PyTorch;
- учитывает 4 компонента функции потерь:
  - `files_counter_loss` - дисперсия числа копий файлов;
  - `object_loss` - дисперсия появления объектов;
  - `class_loss` - дисперсия распределения классов;
  - `superclass_loss` - дисперсия распределения суперклассов.
