# Модуль [`pt_utils.py`](https://github.com/NikitaShubin/dl_utils/blob/main/pt_utils.py "Перейти к модулю")

Содержит набор вспомогательных инструментов для работы с фреймворком PyTorch, включая автоматическое управление вычислительными устройствами, обработку данных и специализированные слои нейронных сетей.
Основной фокус сделан на задачах сегментации изображений.

---
## Основные возможности

### Ключевые функции:
- автоматический выбор и настройка устройств (GPU, MPS, CPU);
- датасет для задач сегментации с поддержкой аугментаций;
- слои для трансформации размеров тензоров (`Sender`, `Receiver`);
- проверка корректности размеров тензоров.

---

## Основные компоненты

### Классы

| Класс         | Описание                                                             |
|---------------|----------------------------------------------------------------------|
| `AutoDevice`  | автоматический выбор и настройка вычислительного устройства          |
| `SegDataset`  | набор данных для загрузки изображений и масок сегментации            |
| `Sender`      | слой-отправитель (увеличивает размер тензора через ConvTranspose2d)  |
| `Receiver`    | слой-приёмник (восстанавливает исходный размер тензора через Conv2d) |

---

## Описание классов

### Класс `AutoDevice`
Упрощает работу с вычислительными устройствами в PyTorch.

#### Статические методы
| Метод                   | Назначение                                                              |
|-------------------------|-------------------------------------------------------------------------|
| `get_avliable_device()` | возвращает доступное устройство (приоритет: CUDA → MPS → CPU)           |
| `prepare_device(device)`| настраивает вычисления для выбранного устройства (TF32 для CUDA и т.д.) |

#### Особенности:
- поддерживает автоматическое определение устройств;
- оптимизирует вычисления для CUDA (включает TF32 на Ampere GPU).

---

### Класс `SegDataset`
Датасет для парных данных (изображение + маска сегментации).

#### Методы
| Метод         | Назначение                                                                |
|---------------|---------------------------------------------------------------------------|
| `__init__()`  | инициализация путей к данным, трансформаций и числа классов               |
| `__getitem__` | возвращает изображение и маску (с One-Hot Encoding при `num_classes > 0`) |

#### Параметры:
- `path`: путь к папкам `inp` (изображения) и `out` (маски);
- `transforms`: аугментации (например, Albumentations);
- `num_classes`: число классов для One-Hot Encoding.

---

### Классы `Sender` и `Receiver`
Слои для изменения размеров тензоров в нейросетях.

#### Конструкторы:
| Параметр          | Описание                             |
|-------------------|--------------------------------------|
| `in_channels`     | число входных каналов                |
| `out_channels`    | число выходных каналов               |
| `kernel_size`     | размер ядра свёртки (по умолчанию 3) |

#### Особенности:
- **Sender**: увеличивает размер тензора в `kernel_size` раз через `ConvTranspose2d`;
- **Receiver**: восстанавливает исходный размер через `Conv2d` с нестандартными параметрами;
- гарантируют сохранение размеров: `Receiver(Sender(x)) == x`.