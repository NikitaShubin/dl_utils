# Модуль `tf_utils.py`

## Общее описание
Модуль `tf_utils.py` содержит набор утилит для работы с TensorFlow, включая:
- Управление GPU и памятью
- Работу с датасетами
- Метрики и слои для моделей
- Интеграцию с Albumentations для аугментации данных

Основные функции модуля используют:
- TensorFlow (`tf`, `tf.keras`)
- OpenCV (`cv2`)
- Вспомогательные модули (`utils`, `alb_utils`)

## Основные компоненты

### Управление GPU и окружением
1. **`TFInit`**:
   - Контекстный менеджер для настройки TensorFlow
   - Возможности:
     - Управление уровнем логирования (`log_level`)
     - Контроль использования памяти GPU (`less_gpu_mem`)
   - Автоматически восстанавливает исходные настройки при выходе

2. **`MultiGPU`**:
   - Утилита для работы с несколькими GPU
   - Функционал:
     - Автоматическое определение доступных GPU
     - Поддержка стратегии `MirroredStrategy`
     - Увеличение `batch_size` пропорционально числу GPU

### Работа с датасетами
1. **`load_IO_file_names2dataset`**:
   - Создаёт датасет из пар входных/выходных файлов
   - Поддерживает структуру папок `inp` и `out`

2. **`make_load_and_transform_func`**:
   - Генерирует функцию для загрузки и преобразования изображений
   - Поддержка:
     - Изменения размера (`target_size`)
     - Albumentations-трансформаций (`transforms`)
     - One-hot кодирования масок (`num_classes`)

3. **`get_dataset`**:
   - Создаёт готовый к использованию `tf.data.Dataset`
   - Особенности:
     - Кеширование данных
     - Поддержка перемешивания (`shuffle`)
     - Пакетная обработка (`batch_size`)
     - Автоматическая предзагрузка (`prefetch`)

4. **`get_datasets`**:
   - Создаёт три стандартных датасета (train/val/test)
   - Автоматически применяет разные трансформации для обучающего и валидационного наборов

### Вспомогательные функции
- **`tf_less_mem`**:
  - Включает режим экономии памяти для GPU

## Интеграция с Albumentations
- Поддержка преобразований через декоратор `@tf.numpy_function`
- Автоматическая композиция трансформаций через `AlbTransforms.compose_transforms`
- Корректная обработка размерностей тензоров после преобразований

## Особенности обработки данных
- Нормализация изображений (приведение к `float32` и масштабирование в [0, 1])
- One-hot кодирование масок сегментации
- Разные методы интерполяции для изображений (`bilinear`) и масок (`nearest`)
- Обработка edge-случаев (неполные батчи при `shuffle=True`)

## Зависимости
- Основные: `tensorflow`, `cv2`
- Вспомогательные: `os`, `sys`
- Локальные модули: `utils`, `alb_utils`
